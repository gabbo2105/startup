<!DOCTYPE html>
<html lang="it">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Hotel Supply Pro</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=DM+Sans:wght@400;500;600;700&display=swap" rel="stylesheet">
  <!-- Marked.js for Markdown rendering -->
  <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
  <!-- Supabase -->
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <style>
    /* ===== LIGHT THEME (default) ===== */
    :root {
      --bg-main: #ffffff;
      --bg-secondary: #f7f7f8;
      --bg-input: #ffffff;
      --bg-input-border: #e0e0e0;
      --bg-hover: #ececec;
      --bg-code: #f3f4f6;
      --text-primary: #1a1a1a;
      --text-secondary: #6b6b6b;
      --text-muted: #999999;
      --text-code: #1a1a1a;
      --border: #e5e5e5;
      --accent: #d4802a;
      --accent-hover: #c0721f;
      --accent-subtle: rgba(212,128,42,0.1);
      --shadow-sm: 0 1px 3px rgba(0,0,0,0.06);
      --shadow-md: 0 4px 12px rgba(0,0,0,0.08);
      --msg-user-bg: var(--bg-secondary);
      --msg-bot-bg: transparent;
      --auth-card-bg: #ffffff;
      --auth-input-bg: #f7f7f8;
    }

    /* ===== DARK THEME ===== */
    @media (prefers-color-scheme: dark) {
      :root {
        --bg-main: #212121;
        --bg-secondary: #2f2f2f;
        --bg-input: #303030;
        --bg-input-border: #424242;
        --bg-hover: #383838;
        --bg-code: #1e1e1e;
        --text-primary: #ececec;
        --text-secondary: #b4b4b4;
        --text-muted: #8e8e8e;
        --text-code: #e0e0e0;
        --border: #383838;
        --accent: #d4802a;
        --accent-hover: #e89540;
        --accent-subtle: rgba(212,128,42,0.15);
        --shadow-sm: 0 1px 3px rgba(0,0,0,0.2);
        --shadow-md: 0 4px 12px rgba(0,0,0,0.3);
        --msg-user-bg: var(--bg-secondary);
        --msg-bot-bg: transparent;
        --auth-card-bg: #2f2f2f;
        --auth-input-bg: #212121;
      }
    }

    * { box-sizing: border-box; margin: 0; padding: 0; }
    html, body { height: 100%; }
    body {
      font-family: 'DM Sans', system-ui, -apple-system, sans-serif;
      background: var(--bg-main); color: var(--text-primary);
      -webkit-font-smoothing: antialiased; line-height: 1.6;
    }
    .hide { display: none !important; }
    a { color: var(--accent); text-decoration: none; cursor: pointer; }
    a:hover { color: var(--accent-hover); }
    ::selection { background: var(--accent-subtle); color: var(--text-primary); }

    /* ===== AUTH PAGES ===== */
    .auth-page { display: flex; align-items: center; justify-content: center; min-height: 100vh; padding: 1.5rem; background: var(--bg-secondary); }
    .auth-box { width: 100%; max-width: 420px; }
    .auth-box--wide { max-width: 520px; }
    .auth-logo { text-align: center; margin-bottom: 1.75rem; }
    .auth-logo h1 { font-size: 1.4rem; font-weight: 700; letter-spacing: -0.02em; }
    .auth-logo h1 span { color: var(--accent); }
    .auth-logo p { color: var(--text-muted); font-size: 0.88rem; margin-top: 0.25rem; }
    .auth-card {
      background: var(--auth-card-bg); border: 1px solid var(--border);
      border-radius: 16px; padding: 1.75rem; box-shadow: var(--shadow-md);
    }
    .st {
      font-size: 0.72rem; font-weight: 700; text-transform: uppercase; letter-spacing: 0.08em;
      color: var(--accent); margin: 1.3rem 0 0.5rem;
    }
    .st:first-child { margin-top: 0; }
    label { display: block; font-size: 0.8rem; color: var(--text-secondary); margin-bottom: 0.2rem; font-weight: 500; }
    input[type="email"], input[type="password"], input[type="text"], input[type="tel"] {
      width: 100%; padding: 0.6rem 0.8rem; background: var(--auth-input-bg);
      border: 1px solid var(--border); border-radius: 10px; color: var(--text-primary);
      font-family: inherit; font-size: 0.88rem; margin-bottom: 0.55rem; outline: none; transition: border-color 0.15s;
    }
    input:focus { border-color: var(--accent); }
    input::placeholder { color: var(--text-muted); }
    .row2 { display: grid; grid-template-columns: 1fr 1fr; gap: 0.55rem; }
    @media(max-width:500px) { .row2 { grid-template-columns: 1fr; } }
    .btn {
      display: inline-flex; align-items: center; justify-content: center; width: 100%;
      padding: 0.65rem; font-family: inherit; font-size: 0.9rem; font-weight: 600;
      border: none; border-radius: 10px; cursor: pointer; transition: all 0.15s;
    }
    .btn:disabled { opacity: 0.5; cursor: not-allowed; }
    .btn-primary { background: var(--accent); color: #fff; }
    .btn-primary:hover:not(:disabled) { background: var(--accent-hover); }
    .btn-ghost {
      background: transparent; color: var(--text-secondary); border: 1px solid var(--border);
      padding: 0.45rem 0.75rem; width: auto; font-size: 0.8rem; font-weight: 500; border-radius: 8px;
    }
    .btn-ghost:hover:not(:disabled) { background: var(--bg-hover); color: var(--text-primary); }
    .err { color: #ef4444; font-size: 0.8rem; min-height: 1em; margin: 0.3rem 0; }
    .ok { color: #22c55e; }
    .lnk { text-align: center; margin-top: 1.1rem; font-size: 0.84rem; color: var(--text-muted); }

    /* ===== DASHBOARD ===== */
    .dash { display: flex; flex-direction: column; height: 100vh; }
    .dash-header {
      display: flex; align-items: center; justify-content: space-between;
      padding: 0 1rem; height: 52px; border-bottom: 1px solid var(--border);
      background: var(--bg-main); flex-shrink: 0;
    }
    .dash-header .logo { font-size: 0.95rem; font-weight: 700; }
    .dash-header .logo span { color: var(--accent); }
    .dash-header .hotel-tag { font-size: 0.78rem; color: var(--text-muted); margin-left: 0.5rem; }
    .dash-right { display: flex; align-items: center; gap: 0.4rem; }
    .dash-right .user-name { font-size: 0.8rem; color: var(--text-secondary); margin-right: 0.25rem; }

    /* ===== MESSAGES ===== */
    .messages-area { flex: 1; overflow-y: auto; }
    .messages-inner { max-width: 720px; margin: 0 auto; padding: 1.25rem 1rem 7rem; }
    .msg { padding: 1.25rem 0; }
    .msg + .msg { border-top: 1px solid var(--border); }
    .msg-head { display: flex; align-items: center; gap: 0.5rem; margin-bottom: 0.5rem; }
    .msg-icon {
      width: 26px; height: 26px; border-radius: 50%; display: flex; align-items: center; justify-content: center;
      font-size: 0.65rem; font-weight: 700; flex-shrink: 0;
    }
    .msg-icon.u { background: var(--bg-hover); color: var(--text-secondary); }
    .msg-icon.b { background: var(--accent); color: #fff; }
    .msg-label { font-size: 0.8rem; font-weight: 600; }
    .msg-label.u { color: var(--text-secondary); }
    .msg-label.b { color: var(--accent); }

    /* ===== MARKDOWN RENDERED CONTENT ===== */
    .msg-body { font-size: 0.92rem; line-height: 1.7; color: var(--text-primary); }
    .msg-body p { margin-bottom: 0.6em; }
    .msg-body p:last-child { margin-bottom: 0; }
    .msg-body strong { font-weight: 600; }
    .msg-body em { font-style: italic; }
    .msg-body ul, .msg-body ol { margin: 0.4em 0 0.6em 1.4em; }
    .msg-body li { margin-bottom: 0.25em; }
    .msg-body li::marker { color: var(--accent); }
    .msg-body h1, .msg-body h2, .msg-body h3, .msg-body h4 {
      font-weight: 700; margin: 1em 0 0.4em; line-height: 1.3;
    }
    .msg-body h1 { font-size: 1.3em; }
    .msg-body h2 { font-size: 1.15em; }
    .msg-body h3 { font-size: 1.05em; }
    .msg-body h4 { font-size: 0.95em; }
    .msg-body code {
      background: var(--bg-code); color: var(--text-code); padding: 0.15em 0.4em;
      border-radius: 5px; font-size: 0.85em; font-family: 'SF Mono', 'Fira Code', 'Consolas', monospace;
    }
    .msg-body pre {
      background: var(--bg-code); border-radius: 10px; padding: 1em; margin: 0.6em 0;
      overflow-x: auto; border: 1px solid var(--border);
    }
    .msg-body pre code { background: none; padding: 0; font-size: 0.82em; line-height: 1.5; }
    .msg-body blockquote {
      border-left: 3px solid var(--accent); padding-left: 0.8em; margin: 0.5em 0;
      color: var(--text-secondary); font-style: italic;
    }
    .msg-body table { border-collapse: collapse; width: 100%; margin: 0.6em 0; font-size: 0.88em; }
    .msg-body th, .msg-body td { border: 1px solid var(--border); padding: 0.45em 0.7em; text-align: left; }
    .msg-body th { background: var(--bg-secondary); font-weight: 600; }
    .msg-body a { color: var(--accent); text-decoration: underline; }
    .msg-body hr { border: none; border-top: 1px solid var(--border); margin: 1em 0; }

    /* ===== TYPING ===== */
    .typing-dots span {
      display: inline-block; width: 8px; height: 8px; background: var(--text-muted);
      border-radius: 50%; margin-right: 5px; animation: tb 1.4s infinite ease-in-out;
    }
    .typing-dots span:nth-child(2) { animation-delay: .15s; }
    .typing-dots span:nth-child(3) { animation-delay: .3s; }
    @keyframes tb { 0%,80%,100%{transform:scale(0.5);opacity:0.3} 40%{transform:scale(1);opacity:1} }

    /* ===== CHIPS ===== */
    .chips { display: flex; flex-wrap: wrap; gap: 0.4rem; margin-top: 0.75rem; }
    .chip {
      padding: 0.4rem 0.85rem; border: 1px solid var(--border); border-radius: 9999px;
      font-size: 0.82rem; color: var(--text-secondary); cursor: pointer; transition: all 0.15s;
      background: var(--bg-main);
    }
    .chip:hover { border-color: var(--accent); color: var(--accent); background: var(--accent-subtle); }

    /* ===== INPUT BAR ===== */
    .input-bar {
      position: absolute; bottom: 0; left: 0; right: 0;
      padding: 0.75rem 1rem 1rem;
      background: linear-gradient(transparent 0%, var(--bg-main) 40%);
      pointer-events: none;
    }
    .input-bar-inner {
      pointer-events: all;
      max-width: 720px; margin: 0 auto; display: flex; align-items: center; gap: 0.5rem;
      background: var(--bg-input); border: 1px solid var(--bg-input-border);
      border-radius: 24px; padding: 0.35rem 0.5rem 0.35rem 1rem;
      box-shadow: var(--shadow-sm); transition: border-color 0.15s, box-shadow 0.15s;
    }
    .input-bar-inner:focus-within { border-color: var(--accent); box-shadow: 0 0 0 2px var(--accent-subtle); }
    .input-bar-inner input {
      flex: 1; background: transparent; border: none; outline: none; color: var(--text-primary);
      font-family: inherit; font-size: 0.9rem; padding: 0.5rem 0; margin: 0;
    }
    .input-bar-inner input::placeholder { color: var(--text-muted); }
    .send-btn {
      width: 34px; height: 34px; border-radius: 50%; background: var(--accent); border: none;
      display: flex; align-items: center; justify-content: center; cursor: pointer;
      transition: background 0.15s; flex-shrink: 0;
    }
    .send-btn:hover { background: var(--accent-hover); }
    .send-btn:disabled { background: var(--bg-hover); cursor: not-allowed; }
    .send-btn svg { width: 16px; height: 16px; }
    .disclaimer {
      pointer-events: all;
      text-align: center; font-size: 0.68rem; color: var(--text-muted);
      margin-top: 0.4rem; max-width: 720px; margin-left: auto; margin-right: auto;
    }

    /* ===== RELATIVE WRAPPER for input-bar positioning ===== */
    .main-wrap { flex: 1; position: relative; display: flex; flex-direction: column; min-height: 0; }
  </style>
</head>
<body>

<!-- ===== LOGIN ===== -->
<div id="pg-login" class="auth-page hide">
  <div class="auth-box">
    <div class="auth-logo">
      <h1>Hotel Supply <span>Pro</span></h1>
      <p>Accedi al tuo account</p>
    </div>
    <div class="auth-card">
      <label>Email</label>
      <input type="email" id="l-email" placeholder="email@esempio.com">
      <label>Password</label>
      <input type="password" id="l-pass" placeholder="La tua password">
      <div class="err" id="l-err"></div>
      <button class="btn btn-primary" id="l-btn" style="margin-top:0.4rem">Accedi</button>
    </div>
    <div class="lnk">Non hai un account? <a id="go-reg">Registrati</a></div>
  </div>
</div>

<!-- ===== REGISTER ===== -->
<div id="pg-register" class="auth-page hide">
  <div class="auth-box auth-box--wide">
    <div class="auth-logo">
      <h1>Hotel Supply <span>Pro</span></h1>
      <p>Crea il tuo account gratuito</p>
    </div>
    <div class="auth-card">
      <div class="st">Accesso</div>
      <label>Email *</label>
      <input type="email" id="r-email" placeholder="email@esempio.com">
      <div class="row2">
        <div><label>Password *</label><input type="password" id="r-pass" placeholder="Min 6 caratteri"></div>
        <div><label>Conferma *</label><input type="password" id="r-pass2" placeholder="Ripeti password"></div>
      </div>
      <div class="st">Azienda</div>
      <label>Ragione sociale *</label>
      <input type="text" id="r-company" placeholder="Hotel Roma S.r.l.">
      <label>Partita IVA *</label>
      <input type="text" id="r-vat" placeholder="IT01234567890">
      <div class="st">Hotel</div>
      <label>Nome hotel *</label>
      <input type="text" id="r-hotel" placeholder="Grand Hotel Roma">
      <label>Indirizzo</label>
      <input type="text" id="r-address" placeholder="Via Roma 1, Roma">
      <div class="st">Referente</div>
      <label>Nome e cognome *</label>
      <input type="text" id="r-contact" placeholder="Mario Rossi">
      <div class="row2">
        <div><label>Ruolo</label><input type="text" id="r-role" placeholder="Resp. acquisti"></div>
        <div><label>Telefono</label><input type="tel" id="r-phone" placeholder="+39 333 123456"></div>
      </div>
      <div class="err" id="r-err"></div>
      <button class="btn btn-primary" id="r-btn" style="margin-top:0.4rem">Crea Account</button>
    </div>
    <div class="lnk">Hai già un account? <a id="go-login">Accedi</a></div>
  </div>
</div>

<!-- ===== DASHBOARD ===== -->
<div id="pg-dash" class="hide">
  <div class="dash">
    <div class="dash-header">
      <div style="display:flex;align-items:center">
        <div class="logo">Hotel Supply <span>Pro</span></div>
        <span class="hotel-tag" id="d-hotel"></span>
      </div>
      <div class="dash-right">
        <span class="user-name" id="d-name"></span>
        <button class="btn-ghost" id="btn-new">
          <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" style="margin-right:4px;vertical-align:-2px"><line x1="12" y1="5" x2="12" y2="19"/><line x1="5" y1="12" x2="19" y2="12"/></svg>Nuova chat
        </button>
        <button class="btn-ghost" id="btn-out">Esci</button>
      </div>
    </div>

    <div class="main-wrap">
      <div class="messages-area" id="msg-area">
        <div class="messages-inner" id="msgs"></div>
      </div>
      <div class="input-bar">
        <div class="input-bar-inner">
          <input type="text" id="cin" placeholder="Scrivi un messaggio...">
          <button class="send-btn" id="btn-send" title="Invia">
            <svg viewBox="0 0 24 24" fill="none" stroke="#fff" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M22 2L11 13"/><path d="M22 2L15 22L11 13L2 9L22 2Z"/></svg>
          </button>
        </div>
        <div class="disclaimer">Hotel Supply Pro può commettere errori. Verifica le informazioni importanti.</div>
      </div>
    </div>
  </div>
</div>

<script>
(function(){
  // ===== CONFIG =====
  var SUPA_URL = 'https://wvlqjpmphfhkctupwvvd.supabase.co';
  var SUPA_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Ind2bHFqcG1waGZoa2N0dXB3dnZkIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NzA3MzMwNjIsImV4cCI6MjA4NjMwOTA2Mn0.Ov8iONgG-Ou4CuoMFBZ3S7WAlhHaEYrjiiE8u6z9MOg';
  var N8N = 'https://gabbo.app.n8n.cloud/webhook/b5092d51-dd56-49c7-9188-820052fd2ba4/chat';

  var sb = window.supabase.createClient(SUPA_URL, SUPA_KEY);
  var customer = null;
  var sessId = crypto.randomUUID();
  var busy = false;

  // ===== MARKED CONFIG =====
  marked.setOptions({
    breaks: true,
    gfm: true,
    headerIds: false,
    mangle: false
  });

  // ===== NAV =====
  function show(id) {
    ['pg-login','pg-register','pg-dash'].forEach(function(p){ document.getElementById(p).classList.add('hide'); });
    document.getElementById(id).classList.remove('hide');
  }
  document.getElementById('go-reg').addEventListener('click', function(){ show('pg-register'); });
  document.getElementById('go-login').addEventListener('click', function(){ show('pg-login'); });

  // ===== LOGIN =====
  document.getElementById('l-btn').addEventListener('click', async function(){
    var email = document.getElementById('l-email').value.trim();
    var pass = document.getElementById('l-pass').value;
    var err = document.getElementById('l-err');
    var btn = document.getElementById('l-btn');
    err.textContent = '';
    if (!email || !pass) { err.textContent = 'Compila email e password.'; return; }
    btn.disabled = true; btn.textContent = 'Caricamento...';
    var result = await sb.auth.signInWithPassword({ email: email, password: pass });
    btn.disabled = false; btn.textContent = 'Accedi';
    if (result.error) {
      err.textContent = result.error.message === 'Invalid login credentials' ? 'Email o password non corretti.' : result.error.message;
    }
  });
  document.getElementById('l-pass').addEventListener('keydown', function(e){ if(e.key==='Enter') document.getElementById('l-btn').click(); });
  document.getElementById('l-email').addEventListener('keydown', function(e){ if(e.key==='Enter') document.getElementById('l-btn').click(); });

  // ===== REGISTER =====
  document.getElementById('r-btn').addEventListener('click', async function(){
    var email = document.getElementById('r-email').value.trim();
    var pass = document.getElementById('r-pass').value;
    var pass2 = document.getElementById('r-pass2').value;
    var err = document.getElementById('r-err');
    var btn = document.getElementById('r-btn');
    err.textContent = '';
    if (pass.length < 6) { err.textContent = 'Password: minimo 6 caratteri.'; return; }
    if (pass !== pass2) { err.textContent = 'Le password non coincidono.'; return; }
    var meta = {
      company_name: document.getElementById('r-company').value.trim(),
      vat_number: document.getElementById('r-vat').value.trim(),
      hotel_name: document.getElementById('r-hotel').value.trim(),
      hotel_address: document.getElementById('r-address').value.trim(),
      contact_person: document.getElementById('r-contact').value.trim(),
      contact_role: document.getElementById('r-role').value.trim(),
      phone: document.getElementById('r-phone').value.trim()
    };
    if (!meta.company_name || !meta.vat_number || !meta.hotel_name || !meta.contact_person) {
      err.textContent = 'Compila tutti i campi con *.'; return;
    }
    btn.disabled = true; btn.textContent = 'Creazione...';
    var result = await sb.auth.signUp({ email: email, password: pass, options: { data: meta } });
    btn.disabled = false; btn.textContent = 'Crea Account';
    if (result.error) { err.textContent = result.error.message; return; }
    if (result.data.user && !result.data.session) {
      err.innerHTML = '<span class="ok">Account creato! Controlla la tua email per confermare, poi accedi.</span>';
    }
  });

  // ===== LOGOUT =====
  document.getElementById('btn-out').addEventListener('click', function(){ sb.auth.signOut(); });

  // ===== LOAD CUSTOMER =====
  async function loadCustomer(userId) {
    var result = await sb.from('customers').select('*').eq('auth_user_id', userId).single();
    customer = result.data || null;
    if (customer) {
      document.getElementById('d-hotel').textContent = customer.hotel_name || '';
      document.getElementById('d-name').textContent = customer.contact_person || '';
    }
  }

  // ===== AUTH STATE =====
  sb.auth.onAuthStateChange(async function(event, session) {
    if (event === 'SIGNED_IN' && session) {
      await loadCustomer(session.user.id);
      show('pg-dash');
      initChat();
    }
    if (event === 'SIGNED_OUT') { customer = null; show('pg-login'); }
  });

  // ===== INIT =====
  (async function(){
    var result = await sb.auth.getSession();
    if (result.data.session) {
      await loadCustomer(result.data.session.user.id);
      show('pg-dash');
      initChat();
    } else { show('pg-login'); }
  })();

  // ===== RENDER MARKDOWN =====
  function renderMd(text) {
    if (!text) return '';
    // Use marked to parse markdown, then sanitize basic XSS
    var html = marked.parse(text);
    return html;
  }

  // For user messages: just escape HTML and preserve newlines
  function renderUser(text) {
    if (!text) return '';
    var d = document.createElement('div');
    d.textContent = text;
    return d.innerHTML.replace(/\n/g, '<br>');
  }

  // ===== CHAT FUNCTIONS =====
  function addMsg(role, text) {
    var el = document.getElementById('msgs');
    var d = document.createElement('div');
    d.className = 'msg';
    var isUser = role === 'user';
    var iconClass = isUser ? 'u' : 'b';
    var iconText = isUser ? 'Tu' : 'HS';
    var labelText = isUser ? 'Tu' : 'Hotel Supply Pro';
    var bodyHtml = isUser ? renderUser(text) : renderMd(text);

    d.innerHTML =
      '<div class="msg-head">' +
        '<div class="msg-icon ' + iconClass + '">' + iconText + '</div>' +
        '<div class="msg-label ' + iconClass + '">' + labelText + '</div>' +
      '</div>' +
      '<div class="msg-body">' + bodyHtml + '</div>';
    el.appendChild(d);
    document.getElementById('msg-area').scrollTop = document.getElementById('msg-area').scrollHeight;
  }

  function showTyping() {
    var el = document.getElementById('msgs');
    var d = document.createElement('div');
    d.className = 'msg'; d.id = 'tp';
    d.innerHTML =
      '<div class="msg-head">' +
        '<div class="msg-icon b">HS</div>' +
        '<div class="msg-label b">Hotel Supply Pro</div>' +
      '</div>' +
      '<div class="msg-body typing-dots"><span></span><span></span><span></span></div>';
    el.appendChild(d);
    document.getElementById('msg-area').scrollTop = document.getElementById('msg-area').scrollHeight;
  }
  function hideTyping() { var t = document.getElementById('tp'); if(t) t.remove(); }

  function initChat() {
    document.getElementById('msgs').innerHTML = '';
    sessId = crypto.randomUUID();
    var name = customer ? (customer.contact_person||'').split(' ')[0] : '';
    addMsg('bot', (name ? 'Ciao **' + name + '**!' : 'Ciao!') + '\n\nSono il tuo assistente per gli acquisti. Posso aiutarti a cercare prodotti, confrontare prezzi e trovare le migliori offerte.\n\nCosa posso fare per te?');

    var el = document.getElementById('msgs');
    var chips = document.createElement('div');
    chips.className = 'chips'; chips.id = 'chps';
    ['Che prosecco avete?', 'Prodotti per la colazione', 'Detersivi per la cucina', 'Confronta prezzi Coca Cola'].forEach(function(t){
      var c = document.createElement('span'); c.className = 'chip'; c.textContent = t;
      c.addEventListener('click', function(){ chips.remove(); doSend(t); });
      chips.appendChild(c);
    });
    el.appendChild(chips);
    document.getElementById('cin').focus();
  }

  async function doSend(text) {
    if (busy) return;
    if (!text) {
      text = document.getElementById('cin').value.trim();
      document.getElementById('cin').value = '';
    }
    if (!text) return;
    var c = document.getElementById('chps'); if(c) c.remove();
    addMsg('user', text);
    busy = true;
    document.getElementById('btn-send').disabled = true;
    showTyping();

    try {
      var res = await fetch(N8N, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({
          chatInput: text, sessionId: sessId,
          customerId: customer ? customer.id : '',
          customerName: customer ? (customer.contact_person||'') : '',
          hotelName: customer ? (customer.hotel_name||'') : '',
          companyName: customer ? (customer.company_name||'') : ''
        })
      });
      hideTyping();
      var data = await res.json();
      var reply = typeof data === 'string' ? data : (data.output||data.text||data.response||data.message||JSON.stringify(data));
      addMsg('bot', reply);
    } catch(e) {
      hideTyping();
      addMsg('bot', 'Errore di comunicazione. Riprova tra qualche istante.');
    }
    busy = false;
    document.getElementById('btn-send').disabled = false;
    document.getElementById('cin').focus();
  }

  document.getElementById('btn-send').addEventListener('click', function(){ doSend(); });
  document.getElementById('cin').addEventListener('keydown', function(e){ if(e.key==='Enter') doSend(); });
  document.getElementById('btn-new').addEventListener('click', function(){ initChat(); });

})();
</script>
</body>
</html>
